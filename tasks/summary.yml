version: '3'

silent: true

output:
  group:
    begin: '::group::{{.TASK}}'
    end: '::endgroup::'

tasks:
  generate-config:
    name: Print the runtime UCI configuration
    run: once
    cmds:
      - |
        printf '## UCI Configuration \n' >> $GITHUB_STEP_SUMMARY
        printf '```dotenv \n' >> $GITHUB_STEP_SUMMARY
        env | grep ^UCI_ | tee -a $GITHUB_STEP_SUMMARY
        printf '``` \n' >> $GITHUB_STEP_SUMMARY

        printf '## Checks outcome as JSON \n' >> $GITHUB_STEP_SUMMARY
        printf '```json \n' >> $GITHUB_STEP_SUMMARY
        cat $GITHUB_ACTION_PATH/uci_checks.json $GITHUB_STEP_SUMMARY
        printf '``` \n' >> $GITHUB_STEP_SUMMARY

  default:
    deps:
      - generate-config
    run: once
    cmds:
      - |
        printf '## Results \n' >> $GITHUB_STEP_SUMMARY

        python3 $GITHUB_ACTION_PATH/scripts/uci/md_table_generator.py  \
        $GITHUB_ACTION_PATH/uci_checks.json >> $GITHUB_STEP_SUMMARY

        python3 $GITHUB_ACTION_PATH/scripts/uci/md_generate_logs.py  \
        $GITHUB_WORKSPACE/reports failed-checks \
        $GITHUB_ACTION_PATH/uci_checks.json >> $GITHUB_STEP_SUMMARY
